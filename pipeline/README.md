# パイプライン
参考: https://go.dev/blog/pipelines

「データを受け取って、何らかの処理をして、どこかに渡す」という操作が連なった、一連の作業。  
この「データを受け取って、何らかの処理をして、どこかに渡す」という操作を「ステージ」という。

つまり、パイプラインはチャネルで接続された複数のステージが連なった処理と言える。  
各ステージのゴルーチンは、

- inboundチャネル（受信・入力チャネル）を経由して（介して）上流から値を受け取る
- 受け取ったデータに対して何か処理を行う、通常は新しい値を生成する
- outboundチャネル（送信・出力チャネル）を経由して（介して）値を下流に送信する

パイプラインを使うことで、各ステージでの懸念事項を切り分けることができるので

- 各ステージを独立して修正することができる
- ステージ同士の組み合わせ方をステージの修正とは独立して変更可能

# 明示的なキャンセル

チャネルを使って複数の段階を連結するので、キャンセルできる仕組みを用意しておかないとブロックされたゴルーチンが残り続けてゴルーチンリークが発生する。
ゴルーチンはGCで回収されない。

例えば、下流段階では、上流段階がチャネルに送っている値の一部しか受信操作しなかったら、上流段階のチャネルへの送信操作がブロックされる。
バッファー付きチャネルを使うのも1つの手だが、処理が変わればバッファー数もうまいこと変更しないといけなくなったりするので、doneチャネルを使うのが一般的。

Go1.7からはdoneチャネルではなくcontextを使うのが主流。

# Pipeline構築時のガイドライン
- ステージは、送信操作が終了したら出力チャネルをクローズする
- ステージは、入力チャネルがクローズするか、（`done`チャネルがクローズされて）送信側のブロックが解放されるまで、入力チャネルから値を受信し続ける
- パイプラインは、送信する値に対して十分なバッファーを保証するか、受信側がチャネルを放棄するときに送信側に明示的にシグナルを送る(doneチャネルやcontext)ことで、送信側のブロックを解放する
